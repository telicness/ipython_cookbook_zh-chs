[*第二章：交互计算之最佳实践*](../)

# 2.9. 使用IPython调试代码


调试是软件开发和交互计算的重要组成部分。一种广泛的调试技术是在代码中的不同位置放置`print()`函数。谁没做过这件事? 这可能是最简单的解决方案，但肯定不是最有效的(这是穷人的调试器)。

IPython非常适合调试，集成调试器非常容易使用(实际上，IPython只是为本地Python调试器**PDB**提供了一个很好的接口)。特别是，选项卡完成在IPython调试器中工作。此配方描述如何使用IPython调试代码。

## 怎么做...

在Python中有两种非互斥的调试代码的方法。在事后分析模式中，调试器在引发异常时就会进入代码，这样我们就可以调查是什么导致了异常。在分步模式中，我们可以在断点处停止解释器，并逐步恢复其执行。这个过程允许我们在执行代码时仔细检查变量的状态。

两种方法实际上可以同时使用;我们可以在事后分析模式下进行逐步调试。

### 事后模式

当在IPython中引发异常时，执行`%%debug`魔法命令来启动调试器并进入代码。此外，`%pdb on`命令告诉IPython，在出现异常时自动启动调试器。

一旦进入调试器，您就可以访问几个特殊的命令，其中最重要的命令列在这里:

* `p varname`**打印**变量的值
* `w`显示堆栈中的当前位置
* `u` 进入**up**在堆栈中
* `u` 进入**down**在堆栈中
* `l` 表示围绕当前位置的**行**代码
* `a`显示当前函数的**参数**

调用堆栈包含代码执行过程中给定位置的所有活动函数的列表。您可以轻松地向上和向下浏览堆栈，以检查函数参数的值。虽然使用起来很简单，但是这种模式应该可以解决大多数bug。对于更复杂的问题，您可能需要进行逐步调试。

### 单步调试

您有几个选项可以开始单步调试模式。首先，为了在代码中的某个地方放置一个断点，请插入以下命令：

```
import pdb
pdb.set_trace()
```

其次，可以使用以下命令从IPython运行脚本：

```
%run -d -b extscript.py:20 script
```

这个命令在调试器的控制下运行`script.py`文件，其中第20行在`extscript.py`(由`script.py`导入)中有一个断点。最后，您可以在调试器中一步地调试.

单步调试包括精确控制解释器的运行过程.从脚本开始或从断点开始，您可以使用以下命令继续执行解释器：

* `s` 执行当前行，然后尽快停止(单步调试，也就是最细粒度的执行模式)。
* `N` 继续执行，直到到达当前函数中的**Next**行为止
* `r` 继续执行，直到当前函数**返回**为止
* `c `**继续执行**，直到到达下一个断点为止
* `j 30`将在当前文件中显示第30行

您可以在调试器中使用`b`命令或使用`t以外`(临时断点)动态添加断点。您还可以清除所有或部分断点，启用或禁用它们，等等。您可以在https://docs.python.org/3/library/pdb.html.上找到调试器的详细信息。

## 还有更多...

要使用IPython调试代码，通常需要首先使用IPython执行它，例如，使用`%run`。然而，您可能并不总是有一个简单的方法来做到这一点。例如，您的程序可以使用定制的命令行Python脚本运行，可以使用复杂的bash脚本启动，或者集成到GUI中。在这些情况下，您可以在代码中的任何位置嵌入一个IPython解释器(由Python启动)，而不是使用IPython运行整个程序(如果您只需要调试一小部分代码，那么使用IPython运行整个程序可能有些过火)。

要在程序中嵌入IPython，只需在代码中插入以下命令:

```
from IPython import embed
embed()
```

当Python程序到达此代码时，它将暂停并在此特定点启动交互式IPython终端。然后，您将能够检查所有局部变量，运行任何您想要的代码，并可能在恢复正常执行之前调试您的代码。

大多数Python ide都提供图形化调试功能(请参阅带有IPython**参考手册的**高效交互计算工作流)。GUI有时比命令行调试器更方便。Python调试器列表可以在https://wiki.python.org/moin/PythonDebuggingTools找到。

