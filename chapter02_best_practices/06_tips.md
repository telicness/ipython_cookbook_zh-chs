[*第二章：交互计算之最佳实践*](../)

# 2.6. 进行可重复交互计算实验的十个技巧

在这个参考手册中，我们提供了十个技巧，可以帮助你进行高效、可重复的交互计算实验。这些与其说是绝对的规则，不如说是指导方针。

首先，我们将展示如何通过最小化重复任务的时间和最大化思考核心工作的时间来提高工作效率。

其次，我们将演示如何在计算工作中获得更多的可重复性。值得注意的是，学术研究需要实验的可重复性，这样任何结果或结论都可以被其他研究者独立地验证。在方法上的错误或操作导致错误的结论并可能造成破坏性后果的情况并不少见。例如，卡门•莱因哈特(Carmen Reinhart)和肯尼斯•罗格夫(Kenneth Rogoff)在2010年发表的《经济增长在债务时期》(economics *Growth in a Time of Debt)研究报告中指出，计算错误是一项有缺陷的研究的部分原因，它对政策制定者具有全球性影响(见https://en.wikipedia.org/wiki/Growth_in_a_Time_of_Debt)。

## 怎么做...

1. 仔细和连贯地组织您的目录结构。具体的结构并不重要。重要的是在整个项目中保持文件命名约定、文件夹、子文件夹等方面的一致性。下面是一个简单的例子：

![File structure](images/folder.png)

2. 使用轻量级标记语言(如**Markdown**(http：/daringFireball.net/projects/markdown/)、**CommonMark**(http：/Commonmark.org/)或**reStrercredText(REST)**)在文本文件中编写注释。所有与您的项目、文件、数据集、代码、数字、实验室NoteBook等相关的元信息都应该写在文本文件中。
3. 相应地，用注释、文档字符串等文档记录代码中的所有重要内容。您可以使用**Sphinx**这样的文档工具(http://sphinx-doc.org)。但是，不要在编写不稳定的和前沿的代码时花费太多时间;它可能经常更改，您的文档可能很快就会过时。以一种无需注释就可以理解的方式编写代码(好的命名变量和函数，使用python模式，等等)。参见下一个参考手册**编写高质量的Python代码**。
4. 对所有基于文本的文件使用Git之类的版本控制系统，但不要使用二进制文件(除非是非常小的文件，因为您确实需要)。每个项目应该使用一个存储库。使用免费或付费的托管提供者(如GitHub、Gitlab或Bitbucket)或您自己的服务器(您的宿主机构可能可以为您设置一个)同步远程服务器上的存储库。使用特定的系统存储和共享二进制数据文件，例如http://figshare.com或http://datadryad.org。
5. 首先在Jupyter Notebook中编写所有交互式计算代码，只有当它足够成熟和稳定时，才将其重构为独立的Python组件。
6. 确保您记录了整个软件堆栈中所有组件的确切版本(操作系统、Python发行版、模块等等)。一种可能是使用带有**virtualenv**或**conda**的虚拟环境。另一种可能是使用**Docker** (https://www.docker.com)。
7. 使用Python的本机**pickle**模块，**dill** (https://github.com/uqfoundation/dill)或**Joblib** (http://pythonhosted.org/joblib/)缓存长到计算的中间结果。Joblib明显地实现了一个支持数字的**memoize**模式(不要与记忆混淆)，它允许您缓存计算密集型函数的结果。

> 如何用Python保存持久数据? 出于纯粹的内部目的，您可以为数组使用Jbusb、NumPy的`save()`和`savez()`函数，以及对任何其他Python对象使用`ching le`(更喜欢本机类型，例如列表和字典，而不是自定义类)。出于共享的目的，喜欢用于小型数据集的文本文件(小于10，000点)，例如，用于数组的CSV，对于高度结构化数据的JSON或YAML。对于更大的数据集，您可以使用HDF5(参见*第4章，分析和优化*中*使用HDF5操纵大数组)。

8. 在开发和试验大型数据集上的算法时，首先运行它们，并在数据的小部分上进行比较，然后再转到完整的数据集。
9. 在批处理中运行作业时，使用并行计算来利用多核处理单元，例如，使用**ipyparallel**、Joblib、**dask** (https://dask.pydata.org/en/latest/)、Python的多处理包或任何其他并行计算库。
10. 尽可能用Python函数或脚本自动化您的工作。对于用户公开的脚本使用命令行参数，但是如果可能的话，更喜欢Python函数而不是脚本。在Unix系统上，学习终端命令来提高您的工作效率。对于Windows或基于gui的系统上的重复任务，使用自动化工具，如**AutoHotKey** (http://www.autohotkey.com)。在你经常使用的程序中学习键盘快捷键，或者创建你自己的快捷键。自动步骤是可复制的，手动步骤则不然。

## 它是如何工作的.。

本参考手册中给出的建议最终旨在优化您的工作流程，从人力时间、计算机时间和质量方面考虑。为代码使用一致的约定和结构使您更容易组织工作。记录每件事都能节省每个人的时间，包括(最终)你的时间!

使用带有在线托管服务的分布式版本控制系统，您可以轻松地从多个位置处理相同的代码库，而不必担心备份问题。由于您可以在代码中回溯到以前，因此无意中破坏它的机会非常小。

Jupyter Notebook是再现交互式计算的优秀工具。它能让你详细记录你的工作。另外，使用Jupyter Notebook的易用性意味着你不必担心可重复性;只需在NoteBook上完成所有的交互工作，将它们置于版本控制之下，并定期提交。不要忘记将代码重构为独立的可重用组件。

一定要优化你花在电脑前的时间。在处理算法时，这个循环经常发生:您进行了轻微的修改，启动代码，获得结果，进行另一次更改，等等。如果您需要尝试许多更改，您应该确保执行时间足够快(不超过几秒钟)。在这个实验阶段，使用高级优化技术不一定是最好的选择。您应该缓存您的结果，在数据子集上试用您的算法，并以较短的持续时间运行您的模拟。当您想要测试不同的参数值时，您还可以并行地启动批处理作业。

最后，拼命避免做重复的工作。当这些任务在你的日常工作中频繁发生时，花时间将它们自动化是值得的。自动化涉及gui的任务更加困难，但由于有了AutoHotKey等免费工具，自动化任务是可行的。

## 还有更多...

以下是一些参考资料：

* Barbagroup再现性教学大纲, at http://lorenabarba.com/blog/barbagroup-reproducibility-syllabus/
* 一种可复制科学的高效工作流程，由特雷弗·贝科莱(Trevor Bekolay)撰写 at http://bekolay.org/scipy2013-workflow/.
* 可重复计算研究的十个简单规则，Sandve等人，PLoS计算生物学，2013年，可用 at http://dx.doi.org/10.1371/journal.pcbi.1003285.
* 软件木工，一个为科学家举办研讨会的志愿者组织;这些研讨会涵盖了科学编程、交互式计算、版本控制、测试、重现性和任务自动化。你可以找到更多的信息 at http://software-carpentry.org.
* 可复制的科学， at https://reproduciblescience.org/

## 另请参阅

* 学习Unix shell的基础知识
* 基于IPython的高效交互计算工作流
* 编写高质量的Python代码


